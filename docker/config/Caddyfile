{
    metrics
}

:80 {
    # Handle ClickHouse API requests (must come first - more specific)
    handle /api/query* {
        # Strip the /api/query part
        rewrite * {path}
        rewrite /api/query /
        rewrite /api/query/* /{1}

        # Forward to ClickHouse server
        reverse_proxy https://clickhouse.nxthdr.dev {
            header_up Host {http.reverse_proxy.upstream.hostport}
            # Pass through common headers
            header_up Content-Type {http.request.header.Content-Type}
            header_up Authorization {http.request.header.Authorization}
            header_up Accept {http.request.header.Accept}

            # Add CORS headers
            header_down Access-Control-Allow-Origin "*"
            header_down Access-Control-Allow-Methods "GET, POST, OPTIONS"
            header_down Access-Control-Allow-Headers "Accept, Content-Type, Authorization, Origin"
        }
    }

    # Handle Peerlab API requests
    handle /api/peerlab/* {
        # Strip /api/peerlab prefix before forwarding
        uri replace /api/peerlab /api 1

        # Forward to peerlab-gateway
        reverse_proxy https://peerlab.nxthdr.dev {
            header_up Host {http.reverse_proxy.upstream.hostport}
            header_up Accept {http.request.header.Accept}
            header_up Content-Type {http.request.header.Content-Type}
            # Pass authorization header through
            header_up Authorization {http.request.header.Authorization}

            # Add CORS headers
            header_down Access-Control-Allow-Origin "*"
            header_down Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            header_down Access-Control-Allow-Headers "Accept, Content-Type, Authorization, Origin"
        }
    }

    # Handle Saimiris API requests
    handle /api/saimiris/* {
        # Strip /api/saimiris prefix before forwarding
        uri replace /api/saimiris /api 1

        # Forward to saimiris
        reverse_proxy https://saimiris.nxthdr.dev {
            header_up Host {http.reverse_proxy.upstream.hostport}
            header_up Accept {http.request.header.Accept}
            header_up Content-Type {http.request.header.Content-Type}
            # Pass authorization header through
            header_up Authorization {http.request.header.Authorization}

            # Add CORS headers
            header_down Access-Control-Allow-Origin "*"
            header_down Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            header_down Access-Control-Allow-Headers "Accept, Content-Type, Authorization, Origin"
        }
    }

    # Serve everything else as static files
    handle {
        root * /www/html
        encode gzip
        file_server
        try_files {path} /index.html
    }
}
